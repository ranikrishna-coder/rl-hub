name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Pages
      uses: actions/configure-pages@v4

    - name: Prepare static files
      env:
        API_URL: ${{ secrets.API_URL || 'https://rl-hub-api.onrender.com' }}
      run: |
        echo "ðŸ“¦ Preparing static files for GitHub Pages..."
        mkdir -p _site
        
        # Copy all static files to root of _site
        cp -r api/static/* _site/
        
        # Create config.js with API endpoint
        cat > _site/config.js <<EOF
        // API Configuration for GitHub Pages
        window.API_BASE = window.API_BASE || '${API_URL}';
        console.log('ðŸš€ RL Hub - API Base URL:', window.API_BASE);
        EOF
        
        # Verify files are in place
        echo "ðŸ“ Files in _site:"
        ls -la _site/ | head -20
        
        # Verify index.html exists
        if [ ! -f "_site/index.html" ]; then
          echo "âŒ ERROR: index.html not found!"
          exit 1
        fi
        
        # Verify config.js was created
        if [ ! -f "_site/config.js" ]; then
          echo "âŒ ERROR: config.js not created!"
          exit 1
        fi
        
        echo "âœ… Static files prepared"
        echo "ðŸ“„ index.html exists: $(test -f _site/index.html && echo 'YES' || echo 'NO')"
        echo "ðŸ“„ config.js exists: $(test -f _site/config.js && echo 'YES' || echo 'NO')"
        echo "ðŸ“„ app.js exists: $(test -f _site/app.js && echo 'YES' || echo 'NO')"
        echo "ðŸ“„ styles.css exists: $(test -f _site/styles.css && echo 'YES' || echo 'NO')"
        echo "ðŸŒ API URL configured: ${API_URL}"

    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: _site

    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

    - name: Deployment summary
      run: |
        echo "## ðŸš€ Deployed to GitHub Pages" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Frontend deployed successfully!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Access URLs:" >> $GITHUB_STEP_SUMMARY
        echo "- **GitHub Pages**: \`https://ranikrishna-coder.github.io/rl-hub/\`" >> $GITHUB_STEP_SUMMARY
        echo "- **API Endpoint**: \`${API_URL}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Files Deployed:" >> $GITHUB_STEP_SUMMARY
        echo "- index.html" >> $GITHUB_STEP_SUMMARY
        echo "- config.js (API: ${API_URL})" >> $GITHUB_STEP_SUMMARY
        echo "- app.js, styles.css, and all assets" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
        echo "1. âœ… Enable GitHub Pages in repository Settings â†’ Pages (Source: GitHub Actions)" >> $GITHUB_STEP_SUMMARY
        echo "2. âœ… Visit: https://ranikrishna-coder.github.io/rl-hub/" >> $GITHUB_STEP_SUMMARY
        echo "3. âš ï¸ Deploy the API to Render if not already done (see \`RENDER_DEPLOYMENT.md\`)" >> $GITHUB_STEP_SUMMARY

name: Auto-Deploy to Render

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy to Render

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Trigger Render deployment
      env:
        RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
      run: |
        echo "üöÄ Triggering Render deployment..."
        response=$(curl -X POST "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys" \
          -H "Authorization: Bearer $RENDER_API_KEY" \
          -H "Content-Type: application/json" \
          -w "\n%{http_code}")
        
        http_code=$(echo "$response" | tail -n1)
        if [ "$http_code" = "201" ]; then
          echo "‚úÖ Deployment triggered successfully!"
        else
          echo "‚ùå Deployment failed. HTTP Code: $http_code"
          echo "Response: $response"
          exit 1
        fi

    - name: Get Render service URL
      env:
        RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
      run: |
        echo "üîç Fetching service URL..."
        service_info=$(curl -s "https://api.render.com/v1/services/$RENDER_SERVICE_ID" \
          -H "Authorization: Bearer $RENDER_API_KEY")
        
        service_url=$(echo "$service_info" | grep -o '"serviceDetails":{[^}]*"url":"[^"]*"' | grep -o '"url":"[^"]*"' | cut -d'"' -f4)
        
        if [ -n "$service_url" ]; then
          echo "üåê Your app is available at: $service_url"
          echo "::set-output name=url::$service_url"
        else
          echo "‚ö†Ô∏è Could not fetch service URL. Check Render dashboard."
        fi


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulation Console - RL Environment</title>
    <link rel="stylesheet" href="test-console.css">
</head>
<body>
    <div class="console-container">
        <header class="console-header">
            <div class="header-content">
                <h1 id="console-title">ü©ª RL Environment - Simulation Console</h1>
                <p class="subtitle">Interactive RL Environment Testing for Healthcare Decision Makers</p>
            </div>
            <button class="btn-back" onclick="window.location.href='index.html'">‚Üê Back to Catalog</button>
        </header>

        <div class="console-layout">
            <!-- Left Panel: Configuration -->
            <div class="panel config-panel">
                <h2>‚öôÔ∏è Configuration - Input</h2>
                
                <div class="config-section">
                    <h3>Environment Selection</h3>
                    <div class="form-group">
                        <label>Software system: <span class="tooltip-icon" title="Filter environments by software system (e.g. Jira, Epic, Cerner, Philips). Select a system to see only environments that integrate with it.">‚ÑπÔ∏è</span></label>
                        <select id="system-select">
                            <option value="all">All systems</option>
                            <!-- Populated by JS -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Environment: <span class="tooltip-icon" title="Select the RL environment you want to simulate. Each environment represents a different workflow optimization scenario.">‚ÑπÔ∏è</span></label>
                        <select id="environment-select">
                            <option value="">Loading environments...</option>
                        </select>
                    </div>
                </div>
                
                <div class="config-section" id="dynamic-config">
                    <h3>Environment Configuration</h3>
                    <div class="empty-state">Select an environment to configure</div>
                </div>

                <div class="config-section">
                    <h3>Verifier Configuration</h3>
                    <div id="jira-verifier-info" class="jira-verifier-info" style="display: none; margin-bottom: 0.75rem; padding: 0.5rem; background: rgba(37,99,235,0.08); border-radius: 6px; font-size: 0.85rem;"></div>
                    <div class="form-group">
                        <label>Reward Verifier: <span class="tooltip-icon" title="Select the reward verifier to use for calculating rewards. For Jira envs, use Default (environment built-in) to match app verifiers (Jira Issue Resolution / Jira Comment Management).">‚ÑπÔ∏è</span></label>
                        <select id="verifier-type">
                            <option value="ensemble" selected>Ensemble (Default - All Verifiers)</option>
                            <option value="clinical">Clinical Verifier</option>
                            <option value="operational">Operational Verifier</option>
                            <option value="financial">Financial Verifier</option>
                            <option value="compliance">Compliance Verifier</option>
                            <option value="default">Default (Environment Built-in)</option>
                        </select>
                    </div>
                    <div class="form-group" id="verifier-weights-group" style="display: none;">
                        <label>Verifier Weights (JSON): <span class="tooltip-icon" title="Optional: Customize verifier weights for reward calculation. Leave empty for defaults.">‚ÑπÔ∏è</span></label>
                        <textarea id="verifier-weights" rows="3" placeholder='{"clinical": 0.4, "operational": 0.3, "financial": 0.2, "compliance": 0.1}'></textarea>
                        <small>Optional: Custom weights for ensemble verifier components</small>
                    </div>
                </div>

                <div class="config-section">
                    <h3>RL Agent Settings</h3>
                    <div class="form-group">
                        <label>Agent Strategy: <span class="tooltip-icon" title="Select the decision-making strategy: Random (baseline), Urgency First (prioritize urgent cases), Value First (prioritize high-value items), or Balanced (RL-optimized approach)">‚ÑπÔ∏è</span></label>
                        <select id="agent-strategy">
                            <option value="random">Random (Baseline)</option>
                            <option value="urgency_first">Urgency First</option>
                            <option value="value_first">High Value First</option>
                            <option value="balanced">Balanced (RL Optimized)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Agent Model: <span class="tooltip-icon" title="Select which trained or baseline model to conceptually use for the agent. In this console, this is used as documentation alongside the Agent Strategy (simulation remains client-side).">‚ÑπÔ∏è</span></label>
                        <select id="agent-model">
                            <option value="baseline" selected>Baseline (no trained model)</option>
                            <option value="ppo">PPO-trained model (offline)</option>
                            <option value="slm">SLM (Jira)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Simulation Speed: <span class="tooltip-icon" title="Control how fast the simulation runs. Slow: 1 step per second (good for detailed observation), Medium: 2 steps/sec (balanced), Fast: 5 steps/sec (quick overview)">‚ÑπÔ∏è</span></label>
                        <select id="sim-speed">
                            <option value="slow">Slow (1 step/sec)</option>
                            <option value="medium" selected>Medium (2 steps/sec)</option>
                            <option value="fast">Fast (5 steps/sec)</option>
                        </select>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-primary" id="btn-initialize" title="Initialize a new simulation episode with the configured parameters. This resets the environment and starts fresh.">Initialize Environment</button>
                    <button class="btn btn-secondary" id="btn-reset" title="Reset the simulation to its initial state, clearing all progress and metrics.">Reset</button>
                </div>
            </div>

            <!-- Center Panel: Simulation View -->
            <div class="panel simulation-panel">
                <div class="panel-header">
                    <h2>üìä Training Simulation <span class="tooltip-icon" title="Interactive simulation view showing the current state of the environment, actions being taken, and historical actions. Use Step Forward to advance one step, Auto Run for continuous simulation, or Stop to pause.">‚ÑπÔ∏è</span></h2>
                    <div class="sim-controls">
                        <button class="btn btn-small" id="btn-step" title="Advance the simulation by one step">Step Forward</button>
                        <button class="btn btn-small" id="btn-auto" title="Run the simulation automatically at the selected speed">Auto Run</button>
                        <button class="btn btn-small btn-danger" id="btn-stop" title="Stop the automatic simulation">Stop</button>
                    </div>
                </div>

                <div class="simulation-view">
                    <div class="queue-display">
                        <h3>üìã Current State <span class="tooltip-icon" title="Shows the current queue of items (orders, patients, appointments, etc.) waiting to be processed. Items are color-coded by urgency: red (STAT/urgent), orange (high priority), yellow (medium), green (low).">‚ÑπÔ∏è</span></h3>
                        <div id="state-display" class="order-list">
                            <div class="empty-state">Click "Initialize Environment" to start</div>
                        </div>
                    </div>

                    <div class="current-action">
                        <h3>üéØ Current Action <span class="tooltip-icon" title="Displays the current action being taken by the RL agent, including the strategy being used and the current simulation step.">‚ÑπÔ∏è</span></h3>
                        <div id="action-display" class="action-box">
                            <div class="empty-state">Waiting for initialization...</div>
                        </div>
                    </div>

                    <div class="processed-orders">
                        <h3>‚úÖ Action History <span class="tooltip-icon" title="Shows the last 5 items that have been processed or actions that have been taken, helping you track the agent's decision-making over time.">‚ÑπÔ∏è</span></h3>
                        <div id="action-history" class="order-list">
                            <div class="empty-state">No actions taken yet</div>
                        </div>
                        <div style="margin-top: 0.5rem;">
                            <button class="btn btn-secondary" id="btn-download-jira-subtasks" title="Download a JSON log of all Jira subtasks created by the agent during this simulation session.">Download</button>
                        </div>
                        <pre id="jira-subtask-console-output" style="margin-top: 0.5rem; padding: 0.5rem; background: #0f172a; color: #e5e7eb; border-radius: 4px; font-size: 0.8rem; max-height: 180px; overflow-y: auto; white-space: pre-wrap;"></pre>
                    </div>
                </div>
            </div>

            <!-- Right Panel: Metrics & KPIs -->
            <div class="panel metrics-panel">
                <h2>üìà Real-Time Metrics - Output <span class="tooltip-icon" title="Live metrics and KPIs showing the performance of the RL agent. Metrics update in real-time as the simulation progresses.">‚ÑπÔ∏è</span></h2>
                
                <div class="metrics-grid" id="metrics-grid">
                    <div class="metric-card" title="Number of simulation steps completed in the current episode">
                        <div class="metric-label">Step Count</div>
                        <div class="metric-value" id="metric-steps">0</div>
                        <div class="metric-trend" id="trend-steps">-</div>
                    </div>
                    <div class="metric-card" title="Cumulative reward earned by the RL agent. Higher rewards indicate better performance according to the environment's reward function.">
                        <div class="metric-label">Total Reward</div>
                        <div class="metric-value" id="metric-reward">0.00</div>
                        <div class="metric-trend" id="trend-reward">-</div>
                    </div>
                </div>

                <div class="human-eval-section" style="margin-top: 1.25rem; padding: 1rem; background: rgba(251,191,36,0.12); border-radius: 8px; border-left: 4px solid #d97706;">
                    <h3>üë§ Human Evaluation <span class="tooltip-icon" title="Record your approval or rejection for this simulation run. For training jobs, use the Training Monitor and open Human Evaluation from the job card.">‚ÑπÔ∏è</span></h3>
                    <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.75rem;">Approve or reject this run (for RLHF / model selection).</p>
                    <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <button type="button" class="btn btn-small" id="human-eval-yes" title="Approve this run">‚úÖ Yes</button>
                        <button type="button" class="btn btn-small" id="human-eval-no" title="Reject this run">‚ùå No</button>
                    </div>
                    <textarea id="human-eval-comment" placeholder="Optional comment‚Ä¶" rows="2" style="width: 100%; padding: 0.5rem; border-radius: 4px; font-size: 0.85rem; resize: vertical; margin-bottom: 0.5rem;"></textarea>
                    <div id="human-eval-status" style="font-size: 0.8rem; color: var(--text-secondary);"></div>
                </div>
            </div>
        </div>

        <!-- Bottom Panel: Results Summary -->
        <div class="results-panel">
            <h2>üìä Simulation Results <span class="tooltip-icon" title="Success and lagging indicators for the RL run. Run summary shows immediate outcomes; lagging indicators help assess long-term behavior and convergence.">‚ÑπÔ∏è</span></h2>
            <div class="results-grid">
                <div class="result-card" title="Immediate outcomes: steps taken, total reward, and whether the episode reached a terminal state. Defines success of the run.">
                    <h4>Run Summary</h4>
                    <div id="results-run-summary" class="result-content">-</div>
                </div>
                <div class="result-card" title="Lagging indicators: average reward per step and steps to complete. Useful for comparing strategies and assessing convergence over time.">
                    <h4>Lagging Indicators</h4>
                    <div id="results-lagging" class="result-content">-</div>
                </div>
            </div>
        </div>
    </div>

    <!-- API Configuration - auto-detects API URL -->
    <script>
        // Auto-detect API URL based on current hostname
        (function() {
            const hostname = window.location.hostname;
            const protocol = window.location.protocol;
            
            // If we're on localhost, use localhost API
            if (hostname === 'localhost' || hostname === '127.0.0.1') {
                window.API_BASE = window.API_BASE || 'http://localhost:8000';
            }
            // If we're on Render, use the current origin (same domain)
            else if (hostname.includes('onrender.com')) {
                window.API_BASE = window.API_BASE || `${protocol}//${hostname}`;
            }
            // If we're on GitHub Pages, use the Render API
            else if (hostname.includes('github.io')) {
                window.API_BASE = window.API_BASE || 'https://rl-hub-api.onrender.com';
            }
            // Default fallback
            else {
                window.API_BASE = window.API_BASE || 'https://rl-hub-api.onrender.com';
            }
            
            console.log('üöÄ RL Hub - Detected API Base URL:', window.API_BASE);
        })();
    </script>
    <!-- Load config.js if it exists (can override auto-detection) -->
    <script src="config.js" onerror="console.log('config.js not found, using auto-detected URL')"></script>
    <script src="simulation-console.js"></script>
    <script>
        // Make formatEnvironmentName available globally
        window.formatEnvironmentName = function(name) {
            return name.replace(/([A-Z])/g, ' $1').trim();
        };
    </script>
</body>
</html>
